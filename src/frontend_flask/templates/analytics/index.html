{% extends "base.html" %}

{% block title %}Analytics & Research - {{ super() }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/analytics.css') }}">
{% endblock %}

{% block content %}
<div class="analytics-container">
    <h2>Analytics & Research</h2>
    
    <!-- Tab Navigation -->
    <div class="tabs">
        <a href="#backtesting" class="tab active" data-tab="backtesting">Backtesting</a>
        <a href="#monte-carlo" class="tab" data-tab="monte-carlo">Monte Carlo</a>
        <a href="#optimization" class="tab" data-tab="optimization">Optimization</a>
        <a href="#data-quality" class="tab" data-tab="data-quality">Data Quality</a>
    </div>
    
    <!-- Tab Content -->
    <div class="tab-content">
        <!-- Backtesting Tab -->
        <div id="backtesting" class="tab-pane active">
            <div class="analytics-grid">
                <!-- Configuration Panel -->
                <div class="config-panel card">
                    <div class="card-header">
                        <h3>Backtest Configuration</h3>
                    </div>
                    <div class="card-body">
                        <form id="backtest-form">
                            <div class="form-group">
                                <label for="backtest-period" class="form-label">Backtest Period</label>
                                <select id="backtest-period" class="form-control">
                                    <option value="7d">7 Days</option>
                                    <option value="30d" selected>30 Days</option>
                                    <option value="90d">90 Days</option>
                                    <option value="180d">180 Days</option>
                                    <option value="1y">1 Year</option>
                                    <option value="2y">2 Years</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="optimize-weights">
                                    Optimize Weights
                                </label>
                            </div>
                            
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="include-macro">
                                    Include Macro Data
                                </label>
                            </div>
                            
                            <button type="submit" class="btn btn-primary btn-block">Run Backtest</button>
                        </form>
                    </div>
                </div>
                
                <!-- Results Panel -->
                <div class="results-panel">
                    <div id="backtest-loading" class="loading-container" style="display: none;">
                        <div class="loading"></div>
                        <p>Running backtest analysis...</p>
                    </div>
                    
                    <div id="backtest-results" style="display: none;">
                        <!-- Performance Metrics -->
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-card-label">Sortino Ratio</div>
                                <div class="metric-card-value" id="sortino-ratio">0.00</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-card-label">Sharpe Ratio</div>
                                <div class="metric-card-value" id="sharpe-ratio">0.00</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-card-label">Max Drawdown</div>
                                <div class="metric-card-value" id="max-drawdown">0.00%</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-card-label">Win Rate</div>
                                <div class="metric-card-value" id="win-rate">0.00%</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-card-label">Total Return</div>
                                <div class="metric-card-value" id="total-return">0.00%</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-card-label">Profit Factor</div>
                                <div class="metric-card-value" id="profit-factor">0.00</div>
                            </div>
                        </div>
                        
                        <!-- Charts -->
                        <div class="chart-grid">
                            <div class="card">
                                <div class="card-header">
                                    <h4>Equity Curve</h4>
                                </div>
                                <div class="card-body">
                                    <div id="equity-curve-chart" style="height: 300px;"></div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h4>Drawdown</h4>
                                </div>
                                <div class="card-body">
                                    <div id="drawdown-chart" style="height: 300px;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Trade Analysis -->
                        <div class="card">
                            <div class="card-header">
                                <h4>Trade Analysis</h4>
                            </div>
                            <div class="card-body">
                                <div class="trade-metrics">
                                    <div class="metric-item">
                                        <span class="metric-label">Total Trades</span>
                                        <span class="metric-value" id="total-trades">0</span>
                                    </div>
                                    <div class="metric-item">
                                        <span class="metric-label">Long Positions</span>
                                        <span class="metric-value" id="long-positions">0</span>
                                    </div>
                                    <div class="metric-item">
                                        <span class="metric-label">Short Positions</span>
                                        <span class="metric-value" id="short-positions">0</span>
                                    </div>
                                    <div class="metric-item">
                                        <span class="metric-label">Avg Turnover</span>
                                        <span class="metric-value" id="avg-turnover">0.0%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Monte Carlo Tab -->
        <div id="monte-carlo" class="tab-pane">
            <div class="analytics-grid">
                <!-- Configuration Panel -->
                <div class="config-panel card">
                    <div class="card-header">
                        <h3>Monte Carlo Configuration</h3>
                    </div>
                    <div class="card-body">
                        <form id="monte-carlo-form">
                            <div class="form-group">
                                <label for="num-simulations" class="form-label">Number of Simulations</label>
                                <input type="number" id="num-simulations" class="form-control" 
                                       value="1000" min="100" max="10000" step="100">
                            </div>
                            
                            <div class="form-group">
                                <label for="time-horizon" class="form-label">Time Horizon (days)</label>
                                <input type="number" id="time-horizon" class="form-control" 
                                       value="365" min="30" max="1825" step="30">
                            </div>
                            
                            <div class="form-group">
                                <label for="confidence-level" class="form-label">Confidence Level</label>
                                <select id="confidence-level" class="form-control">
                                    <option value="0.90">90%</option>
                                    <option value="0.95" selected>95%</option>
                                    <option value="0.99">99%</option>
                                </select>
                            </div>
                            
                            <button type="submit" class="btn btn-primary btn-block">Run Monte Carlo Simulation</button>
                        </form>
                    </div>
                </div>
                
                <!-- Results Panel -->
                <div class="results-panel">
                    <div id="mc-loading" class="loading-container" style="display: none;">
                        <div class="loading"></div>
                        <p>Running Monte Carlo simulation...</p>
                    </div>
                    
                    <div id="mc-results" style="display: none;">
                        <!-- Risk Projections -->
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-card-label">Expected Return</div>
                                <div class="metric-card-value" id="expected-return">0.00%</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-card-label">Value at Risk</div>
                                <div class="metric-card-value" id="var-value">0.00%</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-card-label">Expected Volatility</div>
                                <div class="metric-card-value" id="expected-volatility">0.00%</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-card-label">Probability of Profit</div>
                                <div class="metric-card-value" id="profit-probability">0.00%</div>
                            </div>
                        </div>
                        
                        <!-- Simulation Charts -->
                        <div class="card full-width">
                            <div class="card-header">
                                <h4>Simulation Paths</h4>
                            </div>
                            <div class="card-body">
                                <div id="simulation-paths-chart" style="height: 400px;"></div>
                            </div>
                        </div>
                        
                        <div class="chart-grid">
                            <div class="card">
                                <div class="card-header">
                                    <h4>Returns Distribution</h4>
                                </div>
                                <div class="card-body">
                                    <div id="returns-distribution-chart" style="height: 300px;"></div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h4>Risk Metrics</h4>
                                </div>
                                <div class="card-body">
                                    <div id="risk-metrics-chart" style="height: 300px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Optimization Tab -->
        <div id="optimization" class="tab-pane">
            <div class="analytics-grid">
                <!-- Configuration Panel -->
                <div class="config-panel card">
                    <div class="card-header">
                        <h3>Optimization Configuration</h3>
                    </div>
                    <div class="card-body">
                        <form id="optimization-form">
                            <div class="form-group">
                                <label for="optimization-target" class="form-label">Optimization Target</label>
                                <select id="optimization-target" class="form-control">
                                    <option value="sortino_ratio" selected>Sortino Ratio</option>
                                    <option value="sharpe_ratio">Sharpe Ratio</option>
                                    <option value="total_return">Total Return</option>
                                    <option value="win_rate">Win Rate</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="num-trials" class="form-label">Number of Trials</label>
                                <input type="number" id="num-trials" class="form-control" 
                                       value="100" min="10" max="1000" step="10">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Parameter Ranges</label>
                                <div class="parameter-range">
                                    <label for="stop-loss-range">Stop Loss Range: <span id="sl-range-display">1% - 10%</span></label>
                                    <div class="range-slider">
                                        <input type="range" id="stop-loss-min" min="1" max="10" value="1" step="0.5">
                                        <input type="range" id="stop-loss-max" min="1" max="10" value="10" step="0.5">
                                    </div>
                                </div>
                                
                                <div class="parameter-range">
                                    <label for="take-profit-range">Take Profit Range: <span id="tp-range-display">2% - 20%</span></label>
                                    <div class="range-slider">
                                        <input type="range" id="take-profit-min" min="2" max="20" value="2" step="1">
                                        <input type="range" id="take-profit-max" min="2" max="20" value="20" step="1">
                                    </div>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary btn-block">Run Optimization</button>
                        </form>
                    </div>
                </div>
                
                <!-- Results Panel -->
                <div class="results-panel">
                    <div id="opt-loading" class="loading-container" style="display: none;">
                        <div class="loading"></div>
                        <p>Running optimization...</p>
                    </div>
                    
                    <div id="opt-results" style="display: none;">
                        <!-- Optimal Parameters -->
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-card-label">Optimal Stop Loss</div>
                                <div class="metric-card-value" id="optimal-stop-loss">0.00%</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-card-label">Optimal Take Profit</div>
                                <div class="metric-card-value" id="optimal-take-profit">0.00%</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-card-label">Expected Sortino</div>
                                <div class="metric-card-value" id="expected-sortino">0.00</div>
                            </div>
                        </div>
                        
                        <!-- Optimization Heatmap -->
                        <div class="card full-width">
                            <div class="card-header">
                                <h4>Parameter Optimization Heatmap</h4>
                            </div>
                            <div class="card-body">
                                <div id="optimization-heatmap" style="height: 400px;"></div>
                            </div>
                        </div>
                        
                        <div class="chart-grid">
                            <div class="card">
                                <div class="card-header">
                                    <h4>Convergence Plot</h4>
                                </div>
                                <div class="card-body">
                                    <div id="convergence-plot" style="height: 300px;"></div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h4>Top Parameter Combinations</h4>
                                </div>
                                <div class="card-body">
                                    <table class="data-table" id="top-combinations-table">
                                        <thead>
                                            <tr>
                                                <th>Stop Loss</th>
                                                <th>Take Profit</th>
                                                <th>Sortino</th>
                                            </tr>
                                        </thead>
                                        <tbody id="top-combinations-body">
                                            <!-- Populated by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Data Quality Tab -->
        <div id="data-quality" class="tab-pane">
            <div class="data-quality-container">
                <!-- Overall Metrics -->
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-card-label">Overall Score</div>
                        <div class="metric-card-value" id="overall-score">0.0%</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-card-label">Completeness</div>
                        <div class="metric-card-value" id="completeness-score">0.0%</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-card-label">Accuracy</div>
                        <div class="metric-card-value" id="accuracy-score">0.0%</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-card-label">Timeliness</div>
                        <div class="metric-card-value" id="timeliness-score">0.0%</div>
                    </div>
                </div>
                
                <!-- Data Source Status -->
                <div class="card">
                    <div class="card-header">
                        <h3>Data Source Status</h3>
                    </div>
                    <div class="card-body">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Source</th>
                                    <th>Status</th>
                                    <th>Latency</th>
                                    <th>Success Rate</th>
                                </tr>
                            </thead>
                            <tbody id="source-status-body">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Quality Timeline -->
                <div class="card">
                    <div class="card-header">
                        <h3>Data Quality Timeline (24h)</h3>
                    </div>
                    <div class="card-body">
                        <div id="quality-timeline-chart" style="height: 300px;"></div>
                    </div>
                </div>
                
                <!-- Missing Data Analysis -->
                <div class="card">
                    <div class="card-header">
                        <h3>Missing Data Analysis</h3>
                    </div>
                    <div class="card-body">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Field</th>
                                    <th>Missing Count</th>
                                    <th>Missing %</th>
                                </tr>
                            </thead>
                            <tbody id="missing-data-body">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/analytics.js') }}"></script>
<script>
    // Initialize analytics on page load
    document.addEventListener('DOMContentLoaded', function() {
        initializeAnalytics();
    });
</script>
{% endblock %}